<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>restaurant-cafe-manager</title>
<style>
:root{
  --bg:#0c1526;--card:#0f223d;--card2:#102a4a;--text:#f3f6ff;--muted:#b9c6e6;
  --brand:#2f6bff;--brand2:#18bfa6;--danger:#ff4d4d;--warn:#ffb020;--ok:#2bd972;
  --line:rgba(255,255,255,.10);--shadow:0 14px 40px rgba(0,0,0,.35);
  --radius:18px;--radius2:12px;
  --font: system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic","Noto Sans Arabic", Arial, sans-serif;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:var(--font);
  background:radial-gradient(1200px 600px at 30% 0%,#17305b 0%,var(--bg) 55%,#08101f 100%);
  color:var(--text);
}
.container{max-width:1100px;margin:0 auto;padding:18px 14px 60px}
.header{position:sticky;top:0;z-index:5;backdrop-filter:blur(10px);
  background:linear-gradient(to bottom,rgba(12,21,38,.92),rgba(12,21,38,.55));
  border-bottom:1px solid var(--line);
}
.header .wrap{max-width:1100px;margin:0 auto;padding:14px}
.title{font-size:22px;font-weight:900;letter-spacing:.2px;margin:0}
.subtitle{margin:6px 0 0;color:var(--muted);font-size:13px}
.nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.nav .btn{
  border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);
  padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;
  text-decoration:none;display:inline-flex;align-items:center;justify-content:center;
}
.nav .btn.active{background:rgba(47,107,255,.22);border-color:rgba(47,107,255,.35)}
.section{display:none} .section.active{display:block}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media (min-width:900px){.grid.cols2{grid-template-columns:1.1fr .9fr}}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));
  border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;
}
.card .hd{padding:14px 14px 10px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
  border-bottom:1px solid var(--line);background:rgba(0,0,0,.12);
}
.card .hd h3{margin:0;font-size:16px;font-weight:900}
.card .hd .desc{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.5}
.card .bd{padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.spread{justify-content:space-between}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
  font-size:12px;color:var(--muted);background:rgba(255,255,255,.03);
}
.pill.ok{color:#07140d;background:rgba(43,217,114,.18);border-color:rgba(43,217,114,.25)}
.pill.warn{color:#1a1200;background:rgba(255,176,32,.18);border-color:rgba(255,176,32,.25)}
.kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media (min-width:600px){.kpi{grid-template-columns:repeat(4,1fr)}}
.kpi .box{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi .box .l{font-size:12px;color:var(--muted)} .kpi .box .v{margin-top:6px;font-size:18px;font-weight:900}
.kpi .box .s{margin-top:4px;font-size:12px;color:var(--muted)}
.btn{border:0;background:var(--brand);color:white;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900}
.btn.secondary{background:rgba(255,255,255,.08);border:1px solid var(--line);color:var(--text)}
.btn.ok{background:rgba(24,191,166,.95)} .btn.danger{background:rgba(255,77,77,.95)}
.btn.small{padding:8px 10px;font-weight:800;font-size:13px;border-radius:10px}
.field{display:grid;gap:6px;min-width:160px;flex:1}
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);
  border-radius:12px;padding:10px 10px;outline:none;font-family:var(--font);
}
textarea{min-height:90px;resize:vertical}
.hr{height:1px;background:var(--line);margin:12px 0}
.tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.16)}
table{width:100%;border-collapse:collapse;min-width:820px}
th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:right;vertical-align:top;font-size:13px}
th{position:sticky;top:0;background:rgba(12,21,38,.92);color:var(--muted);font-weight:900;z-index:2}
.badge{display:inline-flex;align-items:center;gap:6px;padding:5px 8px;border-radius:999px;border:1px solid var(--line);
  font-size:12px;background:rgba(255,255,255,.03);
}
.badge.ok{background:rgba(43,217,114,.12);border-color:rgba(43,217,114,.22)}
.badge.warn{background:rgba(255,176,32,.12);border-color:rgba(255,176,32,.22)}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.dow{font-size:12px;color:var(--muted);text-align:center;padding:6px 0}
.day{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:14px;min-height:96px;padding:10px;cursor:pointer;position:relative}
.day.muted{opacity:.45;cursor:default}
.day .num{font-weight:900;font-size:13px;color:var(--muted)}
.day .halls{margin-top:8px;display:grid;gap:6px}
.hallBox{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 8px;border-radius:12px;border:1px solid var(--line);
  background:rgba(0,0,0,.14);font-size:12px;color:var(--muted);
}
.hallBox.booked{border-color:rgba(47,107,255,.35);background:rgba(47,107,255,.14);color:var(--text)}
.day.hasBookings{outline:2px solid rgba(47,107,255,.22)}
.day.hasBookings::after{content:"";position:absolute;top:10px;left:10px;width:10px;height:10px;border-radius:50%;
  background:rgba(47,107,255,.9);box-shadow:0 0 0 4px rgba(47,107,255,.15);
}
.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;pointer-events:none;z-index:99;align-items:flex-end;justify-content:center}
.modalBack.show{display:flex;pointer-events:auto}
.modal{width:min(1000px,100%);max-height:88vh;overflow:auto;background:linear-gradient(180deg,rgba(16,42,74,.98),rgba(12,21,38,.98));
  border:1px solid rgba(255,255,255,.12);border-radius:22px 22px 0 0;box-shadow:0 26px 70px rgba(0,0,0,.55);padding:14px;
}
.modal .mh{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:8px 4px 10px;border-bottom:1px solid var(--line)}
.modal .mh h3{margin:0;font-size:16px;font-weight:900} .modal .mc{padding:12px 4px}
.toast{position:fixed;left:12px;right:12px;bottom:12px;max-width:980px;margin:0 auto;padding:12px 14px;border-radius:14px;
  border:1px solid var(--line);background:rgba(0,0,0,.55);backdrop-filter:blur(8px);color:var(--text);display:none;z-index:120;
}
.toast.show{display:block}
.smallNote{font-size:12px;color:var(--muted);line-height:1.6}
</style>
</head>
<body>

<div class="header">
  <div class="wrap">
    <h1 class="title">restaurant-cafe-manager</h1>
    <div class="subtitle">ملف واحد • تخزين على الموبايل تلقائياً • بدون تسجيل دخول (يمكن تفعيل الصلاحيات لاحقاً)</div>
    <div class="nav" id="nav">
      <a class="btn active" href="#home" data-go="home">الرئيسية</a>
      <a class="btn" href="#bookings" data-go="bookings">إدارة الحجوزات</a>
      <a class="btn" href="#cash" data-go="cash">الإيرادات والمصروفات</a>
      <a class="btn" href="#stock" data-go="stock">المخزون والمشتريات</a>
      <a class="btn" href="#hr" data-go="hr">شؤون العاملين</a>
      <a class="btn" href="#users" data-go="users">إدارة المستخدمين</a>
      <a class="btn" href="#backup" data-go="backup">نسخ احتياطي</a>
    </div>
  </div>
</div>

<div class="container">

  <div id="sec-home" class="section active">
    <div class="grid cols2">
      <div class="card">
        <div class="hd">
          <div>
            <h3>لوحة سريعة</h3>
            <div class="desc">ملخص للحجوزات والمتبقي والصندوق والمخزون.</div>
          </div>
          <span class="pill">العملة: جنيه مصري</span>
        </div>
        <div class="bd">
          <div class="kpi">
            <div class="box"><div class="l">حجوزات هذا الشهر</div><div class="v" id="kpiMonthBookings">0</div><div class="s" id="kpiMonthBookingsSub">—</div></div>
            <div class="box"><div class="l">إجمالي المتبقي</div><div class="v" id="kpiRemaining">0</div><div class="s">من حجوزات القاعات</div></div>
            <div class="box"><div class="l">صافي الصندوق</div><div class="v" id="kpiCashNet">0</div><div class="s">مقبوضات - مدفوعات</div></div>
            <div class="box"><div class="l">عدد أصناف المخزن</div><div class="v" id="kpiItems">0</div><div class="s">مع رصيد كمي</div></div>
          </div>
          <div class="hr"></div>
          <div class="row spread">
            <div class="smallNote">كل البيانات محفوظة داخل المتصفح. استخدم “نسخ احتياطي” يومياً لو بتبدّل جهاز/متصفح.</div>
            <div class="row">
              <button class="btn secondary small" data-nav="bookings">اذهب للحجوزات</button>
              <button class="btn secondary small" data-nav="stock">اذهب للمخزن</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div><h3>حالة النظام</h3><div class="desc">بدون تسجيل دخول حالياً.</div></div>
          <span class="pill ok" id="pillAuth">الدخول مباشر</span>
        </div>
        <div class="bd">
          <div class="row">
            <span class="pill">التخزين: محلي</span>
            <span class="pill">الإصدار: v1</span>
          </div>
          <div class="hr"></div>
          <div class="help">لو ظهر 404 على Vercel: تأكد إن الملف اسمه index.html في الجذر، ثم انتظر Deploy الأخير.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="sec-bookings" class="section">
    <div class="card">
      <div class="hd">
        <div><h3>إدارة حجوزات القاعات</h3><div class="desc">تقويم شهري + بحث/فلترة + إجمالي المتبقي + فترة صباحية/مسائية.</div></div>
        <span class="pill">القاعات: كابيتال • برادايس • Sky • الماسا</span>
      </div>
      <div class="bd">
        <div class="row" style="align-items:flex-end">
          <div class="field" style="max-width:220px"><label>الشهر</label><select id="calMonth"></select></div>
          <div class="field" style="max-width:160px"><label>السنة</label><select id="calYear"></select></div>
          <div class="field" style="max-width:220px"><label>بحث باسم العميل</label><input id="bkSearch" placeholder="اكتب اسم العميل..." /></div>
          <div class="field" style="max-width:240px"><label>فلترة بتاريخ</label><input id="bkFilterDate" type="date" /></div>
          <div class="row">
            <button class="btn secondary small" onclick="resetBookingFilters()">مسح</button>
            <button class="btn small" onclick="openBookingModal()">إضافة حجز</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row spread">
          <div class="row">
            <span class="pill" id="bkCountPill">عدد الحجوزات: 0</span>
            <span class="pill warn" id="bkRemainingPill">إجمالي المتبقي: 0</span>
          </div>
          <button class="btn secondary small" onclick="openCalendarLegend()">مفتاح الألوان</button>
        </div>

        <div class="hr"></div>

        <div class="calendar" id="calendar"></div>

        <div class="hr"></div>

        <div class="tableWrap">
          <table>
            <thead><tr>
              <th>التاريخ</th><th>الفترة</th><th>القاعة</th><th>العميل</th><th>الهاتف</th><th>إجمالي</th><th>مدفوع</th><th>متبقي</th><th>إجراءات</th>
            </tr></thead>
            <tbody id="bookingsTbody"></tbody>
          </table>
        </div>

        <div class="smallNote" style="margin-top:10px">يمكن سداد المتبقي على دفعات عبر تعديل المدفوع.</div>
      </div>
    </div>
  </div>

  <div id="sec-cash" class="section">
    <div class="card">
      <div class="hd">
        <div><h3>الإيرادات والمصروفات (الصندوق)</h3><div class="desc">تسجيل المقبوضات والمدفوعات اليومية.</div></div>
        <span class="pill" id="cashPill">صافي: 0</span>
      </div>
      <div class="bd">
        <div class="grid cols2">
          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>إضافة حركة</h3><div class="desc">مقبوضات/مدفوعات + وصف.</div></div><span class="pill">EGP</span></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>التاريخ</label><input id="cashDate" type="date" /></div>
                <div class="field"><label>النوع</label><select id="cashType"><option value="in">مقبوضات</option><option value="out">مدفوعات</option></select></div>
              </div>
              <div class="row">
                <div class="field"><label>القسم</label><select id="cashDept">
                  <option value="restaurant_cafe">المطعم والكافيه</option><option value="halls">القاعات</option><option value="kids">كيدز اريا</option><option value="other">أخرى</option>
                </select></div>
                <div class="field"><label>المبلغ (جنيه)</label><input id="cashAmount" type="number" step="0.01" placeholder="0" /></div>
              </div>
              <div class="field"><label>وصف</label><input id="cashNote" placeholder="اختياري" /></div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" onclick="addCash()">حفظ</button>
                <button class="btn secondary" onclick="fillTodayCash()">اليوم</button>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>تقرير</h3><div class="desc">فلترة حسب الفترة.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>من</label><input id="cashFrom" type="date" /></div>
                <div class="field"><label>إلى</label><input id="cashTo" type="date" /></div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn secondary" onclick="applyCashRange()">تطبيق</button>
                <button class="btn secondary" onclick="resetCashRange()">مسح</button>
              </div>
              <div class="hr"></div>
              <div class="kpi">
                <div class="box"><div class="l">مقبوضات</div><div class="v" id="cashSumIn">0</div></div>
                <div class="box"><div class="l">مدفوعات</div><div class="v" id="cashSumOut">0</div></div>
                <div class="box"><div class="l">الصافي</div><div class="v" id="cashNet">0</div></div>
                <div class="box"><div class="l">عدد الحركات</div><div class="v" id="cashCount">0</div></div>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tableWrap">
          <table>
            <thead><tr><th>التاريخ</th><th>النوع</th><th>القسم</th><th>المبلغ</th><th>الوصف</th><th>إجراءات</th></tr></thead>
            <tbody id="cashTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<div id="sec-stock" class="section">
    <div class="card">
      <div class="hd">
        <div><h3>المخزون والمشتريات</h3><div class="desc">رصيد الأصناف + مشتريات + منصرف يومي + جرد فعلي وإظهار عجز/زيادة.</div></div>
        <div class="row">
          <span class="pill" id="stockItemsPill">الأصناف: 0</span>
          <span class="pill" id="stockValuePill">رصيد كمي: 0</span>
        </div>
      </div>
      <div class="bd">

        <div class="grid cols2">
          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>صنف مخزون</h3><div class="desc">وحدات: وحدة/كيلو/لتر/علبة/كرتونة.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>اسم الصنف</label><input id="itemName" placeholder="مثال: سكر" /></div>
                <div class="field" style="max-width:160px"><label>الوحدة</label>
                  <select id="itemUnit">
                    <option value="وحدة">وحدة</option><option value="كيلو">كيلو</option><option value="لتر">لتر</option><option value="علبة">علبة</option><option value="كرتونة">كرتونة</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="field"><label>رصيد افتتاحي</label><input id="itemQty" type="number" step="0.01" placeholder="0" /></div>
                <div class="field"><label>ملاحظات</label><input id="itemNote" placeholder="اختياري" /></div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" onclick="saveItem()">حفظ</button>
                <button class="btn secondary" onclick="resetItemForm()">تفريغ</button>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>المشتريات</h3><div class="desc">تُضاف تلقائياً لرصيد المخزن.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>التاريخ</label><input id="purDate" type="date" /></div>
                <div class="field"><label>الصنف</label><select id="purItem"></select></div>
              </div>
              <div class="row">
                <div class="field"><label>الكمية</label><input id="purQty" type="number" step="0.01" placeholder="0" /></div>
                <div class="field"><label>مورد</label><input id="purSupplier" placeholder="اختياري" /></div>
              </div>
              <div class="row">
                <div class="field"><label>التكلفة</label><input id="purCost" type="number" step="0.01" placeholder="اختياري" /></div>
                <div class="field"><label>ملاحظات</label><input id="purNote" placeholder="اختياري" /></div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" onclick="addPurchase()">إضافة</button>
                <button class="btn secondary" onclick="fillTodayPurchase()">اليوم</button>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid cols2">
          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>المنصرف اليومي</h3><div class="desc">يخصم من رصيد المخزن.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>التاريخ</label><input id="outDate" type="date" /></div>
                <div class="field"><label>الصنف</label><select id="outItem"></select></div>
              </div>
              <div class="row">
                <div class="field"><label>الكمية المنصرفة</label><input id="outQty" type="number" step="0.01" placeholder="0" /></div>
                <div class="field"><label>ملاحظات</label><input id="outNote" placeholder="اختياري" /></div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" onclick="addOut()">تسجيل</button>
                <button class="btn secondary" onclick="fillTodayOut()">اليوم</button>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>الجرد الفعلي</h3><div class="desc">مقارنة الفعلي مع المسجل وإظهار عجز/زيادة.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>تاريخ الجرد</label><input id="invDate" type="date" /></div>
                <div class="field"><label>الصنف</label><select id="invItem"></select></div>
              </div>
              <div class="row">
                <div class="field"><label>الكمية الفعلية</label><input id="invActual" type="number" step="0.01" placeholder="0" /></div>
                <div class="field"><label>ملاحظات</label><input id="invNote" placeholder="اختياري" /></div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" onclick="addInventoryCheck()">حفظ</button>
                <button class="btn secondary" onclick="fillTodayInv()">اليوم</button>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tableWrap">
          <table>
            <thead><tr>
              <th>الصنف</th><th>الوحدة</th><th>رصيد افتتاحي</th><th>مشتريات</th><th>منصرف</th><th>الرصيد الحالي</th><th>إجراءات</th>
            </tr></thead>
            <tbody id="itemsTbody"></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <div class="grid cols2">
          <div class="tableWrap">
            <table>
              <thead><tr><th colspan="6">سجل المشتريات</th></tr>
                <tr><th>التاريخ</th><th>الصنف</th><th>الكمية</th><th>المورد</th><th>التكلفة</th><th>إجراءات</th></tr>
              </thead>
              <tbody id="purTbody"></tbody>
            </table>
          </div>
          <div class="tableWrap">
            <table>
              <thead><tr><th colspan="5">سجل المنصرف</th></tr>
                <tr><th>التاريخ</th><th>الصنف</th><th>الكمية</th><th>ملاحظات</th><th>إجراءات</th></tr>
              </thead>
              <tbody id="outTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tableWrap">
          <table>
            <thead><tr><th colspan="7">سجل الجرد</th></tr>
              <tr><th>التاريخ</th><th>الصنف</th><th>المسجل</th><th>الفعلي</th><th>الفرق</th><th>الحالة</th><th>إجراءات</th></tr>
            </thead>
            <tbody id="invTbody"></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <div id="sec-hr" class="section">
    <div class="card">
      <div class="hd">
        <div><h3>شؤون العاملين</h3><div class="desc">حضور/انصراف + رواتب (30 يوم) + سلف/مكافآت/جزاءات.</div></div>
        <span class="pill" id="empCountPill">عدد العاملين: 0</span>
      </div>
      <div class="bd">
        <div class="grid cols2">
          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>إضافة عامل</h3><div class="desc">اسم + وظيفة + راتب شهري.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>الاسم</label><input id="empName" /></div>
                <div class="field"><label>الوظيفة</label><input id="empRole" /></div>
              </div>
              <div class="row">
                <div class="field"><label>الراتب الشهري</label><input id="empSalary" type="number" step="0.01" placeholder="0" /></div>
                <div class="field"><label>ملاحظات</label><input id="empNote" placeholder="اختياري" /></div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" onclick="addEmployee()">حفظ</button>
                <button class="btn secondary" onclick="resetEmpForm()">تفريغ</button>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>حضور/انصراف</h3><div class="desc">تسجيل يومي.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>التاريخ</label><input id="attDate" type="date" /></div>
                <div class="field"><label>العامل</label><select id="attEmp"></select></div>
              </div>
              <div class="row">
                <div class="field"><label>حضور</label><input id="attIn" type="time" /></div>
                <div class="field"><label>انصراف</label><input id="attOut" type="time" /></div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" onclick="addAttendance()">حفظ</button>
                <button class="btn secondary" onclick="fillTodayAtt()">اليوم</button>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid cols2">
          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>حركة مالية</h3><div class="desc">سلفة/مكافأة/جزاء.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>التاريخ</label><input id="empTxDate" type="date" /></div>
                <div class="field"><label>العامل</label><select id="empTxEmp"></select></div>
              </div>
              <div class="row">
                <div class="field"><label>النوع</label>
                  <select id="empTxType"><option value="advance">سلفة</option><option value="bonus">مكافأة</option><option value="penalty">جزاء</option></select>
                </div>
                <div class="field"><label>المبلغ</label><input id="empTxAmount" type="number" step="0.01" placeholder="0" /></div>
              </div>
              <div class="field"><label>ملاحظات</label><input id="empTxNote" placeholder="اختياري" /></div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" onclick="addEmpTx()">حفظ</button>
                <button class="btn secondary" onclick="fillTodayEmpTx()">اليوم</button>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>حساب رواتب</h3><div class="desc">تقديري حسب الفترة.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>من</label><input id="payFrom" type="date" /></div>
                <div class="field"><label>إلى</label><input id="payTo" type="date" /></div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn secondary" onclick="calcPayroll()">حساب</button>
                <button class="btn secondary" onclick="resetPayroll()">مسح</button>
              </div>
              <div class="hr"></div>
              <div class="smallNote" id="payrollResult">اختر فترة واضغط حساب.</div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tableWrap">
          <table>
            <thead><tr><th>العامل</th><th>الوظيفة</th><th>الراتب الشهري</th><th>اليومي</th><th>ملاحظات</th><th>إجراءات</th></tr></thead>
            <tbody id="empTbody"></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <div class="grid cols2">
          <div class="tableWrap">
            <table>
              <thead><tr><th colspan="6">سجل الحضور/الانصراف</th></tr>
                <tr><th>التاريخ</th><th>العامل</th><th>حضور</th><th>انصراف</th><th>—</th><th>إجراءات</th></tr>
              </thead>
              <tbody id="attTbody"></tbody>
            </table>
          </div>
          <div class="tableWrap">
            <table>
              <thead><tr><th colspan="6">حركات مالية</th></tr>
                <tr><th>التاريخ</th><th>العامل</th><th>النوع</th><th>المبلغ</th><th>ملاحظات</th><th>إجراءات</th></tr>
              </thead>
              <tbody id="empTxTbody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="sec-users" class="section">
    <div class="card">
      <div class="hd"><div><h3>إدارة المستخدمين</h3><div class="desc">تجهيز للتفعيل لاحقاً (بدون فرض تسجيل دخول الآن).</div></div>
        <span class="pill" id="authEnabledPill">الصلاحيات: غير مفعلة</span>
      </div>
      <div class="bd">
        <div class="grid cols2">
          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>تفعيل الصلاحيات</h3><div class="desc">زر تفعيل/إيقاف (لا يفرض دخول في هذه النسخة).</div></div></div>
            <div class="bd">
              <div class="row">
                <button class="btn secondary" onclick="toggleAuth(false)">إيقاف</button>
                <button class="btn secondary" onclick="toggleAuth(true)">تفعيل</button>
              </div>
              <div class="hr"></div>
              <div class="smallNote">الأدوار: مدير، محاسب، مسؤول مشتريات، مسؤول مخزن، موظف حضور/انصراف.</div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="hd"><div><h3>إضافة مستخدم</h3><div class="desc">وصف وصلاحيات.</div></div></div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>اسم المستخدم</label><input id="uName" /></div>
                <div class="field"><label>الوصف</label><input id="uDesc" placeholder="مثال: مدير" /></div>
              </div>
              <div class="row">
                <div class="field"><label>كلمة مرور (اختياري)</label><input id="uPass" /></div>
                <div class="field"><label>الدور</label>
                  <select id="uRole">
                    <option value="manager">مدير</option><option value="accountant">محاسب</option><option value="buyer">مسؤول مشتريات</option>
                    <option value="storekeeper">مسؤول مخزن</option><option value="attendance">حضور/انصراف</option>
                  </select>
                </div>
              </div>
              <div class="hr"></div>
              <div class="row">
                <label class="pill"><input type="checkbox" id="permBookings" checked /> الحجوزات</label>
                <label class="pill"><input type="checkbox" id="permCash" checked /> الصندوق</label>
                <label class="pill"><input type="checkbox" id="permStock" checked /> المخزون</label>
                <label class="pill"><input type="checkbox" id="permHr" checked /> العاملين</label>
                <label class="pill"><input type="checkbox" id="permUsers" /> المستخدمين</label>
                <label class="pill"><input type="checkbox" id="permDelete" /> حذف/تعديل</label>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" onclick="addUser()">إضافة</button>
                <button class="btn secondary" onclick="resetUserForm()">تفريغ</button>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tableWrap">
          <table>
            <thead><tr><th>اسم المستخدم</th><th>الوصف</th><th>الدور</th><th>الصلاحيات</th><th>إجراءات</th></tr></thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <div id="sec-backup" class="section">
    <div class="card">
      <div class="hd"><div><h3>نسخ احتياطي</h3><div class="desc">تصدير/استيراد JSON.</div></div><span class="pill">يُنصح يومياً</span></div>
      <div class="bd">
        <div class="row">
          <button class="btn ok" onclick="exportJSON()">تصدير</button>
          <label class="btn secondary" style="display:inline-flex;align-items:center;gap:8px">
            استيراد
            <input type="file" accept="application/json" style="display:none" onchange="importJSONFile(event)" />
          </label>
          <button class="btn danger" onclick="resetAllData()">مسح الكل</button>
        </div>
        <div class="hr"></div>
        <div class="field"><label>استيراد يدوي (الصق JSON)</label><textarea id="impTxt"></textarea></div>
        <div class="row" style="margin-top:10px"><button class="btn ok" onclick="doImport()">استيراد</button></div>
      </div>
    </div>
  </div>

</div>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="mh">
      <h3 id="modalTitle">—</h3>
      <button class="btn secondary small" onclick="closeModal()">إغلاق</button>
    </div>
    <div class="mc" id="modalContent"></div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="t" id="toastT">—</div>
  <div class="s" id="toastS">—</div>
</div>

<script>
const STORE_KEY = "restocafe_v1";
const defaultData = () => ({
  authEnabled:false, session:{user:null}, users:[],
  halls:["قاعة كابيتال","قاعة برادايس","قاعة Sky","قاعة الماسا"],
  bookings:[], cash:[], items:[], purchases:[], stockOut:[], inventoryChecks:[],
  employees:[], attendance:[], empTx:[]
});
let DB = loadDB();
let cashRange = {from:"",to:""};
let __editItemId = null;

function loadDB(){
  try{ const raw=localStorage.getItem(STORE_KEY); if(!raw) return defaultData();
    return Object.assign(defaultData(), JSON.parse(raw));
  }catch(e){ return defaultData(); }
}
function saveDB(){ localStorage.setItem(STORE_KEY, JSON.stringify(DB)); }
function uid(p="id"){ return p+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function egp(n){ n=Number(n||0); return n.toLocaleString("ar-EG",{maximumFractionDigits:2}); }
function todayISO(){ const d=new Date(); const z=x=>String(x).padStart(2,"0"); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function val(id){ return document.getElementById(id)?.value ?? ""; }
function esc(s){
  return String(s||"").replaceAll("&","&").replaceAll("<","<").replaceAll(">",">").replaceAll('"',""").replaceAll("'","'");
}
function toast(t,s=""){ const el=document.getElementById("toast"); if(!el) return;
  document.getElementById("toastT").textContent=t; document.getElementById("toastS").textContent=s;
  el.classList.add("show"); clearTimeout(window.__toastT); window.__toastT=setTimeout(()=>el.classList.remove("show"),2200);
}

/* Navigation */
const NAV_MAP={home:"sec-home",bookings:"sec-bookings",cash:"sec-cash",stock:"sec-stock",hr:"sec-hr",users:"sec-users",backup:"sec-backup"};
function setActiveNav(where){
  document.querySelectorAll("#nav .btn").forEach(a=>a.classList.remove("active"));
  document.querySelector(`#nav .btn[data-go="${where}"]`)?.classList.add("active");
}
function go(where){
  const id = NAV_MAP[where] || NAV_MAP.home;
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id)?.classList.add("active");
  setActiveNav(where);
  if(location.hash !== "#"+where) history.replaceState(null,"","#"+where);
  refreshAll();
}
function activateByHash(){
  const w=(location.hash||"#home").slice(1);
  go(NAV_MAP[w]?w:"home");
}
function bindNav(){
  document.getElementById("nav")?.addEventListener("click",(e)=>{
    const a=e.target.closest("a.btn[data-go]");
    if(!a) return;
    e.preventDefault();
    go(a.dataset.go);
  });
  window.addEventListener("hashchange",activateByHash);
}
function openModal(title, html){
  document.getElementById("modalTitle").textContent=title;
  document.getElementById("modalContent").innerHTML=html;
  document.getElementById("modalBack").classList.add("show");
}
function closeModal(){
  document.getElementById("modalBack").classList.remove("show");
  document.getElementById("modalContent").innerHTML="";
}
function bindModal(){
  document.getElementById("modalBack")?.addEventListener("click",(e)=>{
    if(e.target.id==="modalBack") closeModal();
  });
}

/* Calendar selectors */
function initCalendarSelectors(){
  const m=document.getElementById("calMonth"), y=document.getElementById("calYear");
  if(!m||!y) return;
  const months=["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
  m.innerHTML=months.map((n,i)=>`<option value="${i}">${n}</option>`).join("");
  const thisYear=new Date().getFullYear();
  y.innerHTML=Array.from({length:7},(_,k)=>thisYear-3+k).map(yy=>`<option value="${yy}">${yy}</option>`).join("");
  m.value=new Date().getMonth(); y.value=thisYear;
  m.addEventListener("change",()=>{renderCalendar();refreshBookings();updateHomeKPIs();});
  y.addEventListener("change",()=>{renderCalendar();refreshBookings();updateHomeKPIs();});
  document.getElementById("bkSearch")?.addEventListener("input",refreshBookings);
  document.getElementById("bkFilterDate")?.addEventListener("change",refreshBookings);
}

/* Home KPIs */
function updateHomeKPIs(){
  const m=document.getElementById("calMonth"), y=document.getElementById("calYear");
  if(!m||!y) return;
  const month=Number(m.value), year=Number(y.value);
  const from=new Date(year,month,1), to=new Date(year,month+1,1);
  const monthBookings=DB.bookings.filter(b=>{const d=new Date(b.date); return d>=from&&d<to;});
  document.getElementById("kpiMonthBookings").textContent=monthBookings.length;
  document.getElementById("kpiMonthBookingsSub").textContent=monthBookings.length?"حجوزات ضمن الشهر المحدد":"لا يوجد";
  document.getElementById("kpiRemaining").textContent=egp(DB.bookings.reduce((s,b)=>s+Number(b.remaining||0),0));
  const sumIn=DB.cash.filter(x=>x.type==="in").reduce((s,x)=>s+Number(x.amount||0),0);
  const sumOut=DB.cash.filter(x=>x.type==="out").reduce((s,x)=>s+Number(x.amount||0),0);
  document.getElementById("kpiCashNet").textContent=egp(sumIn-sumOut);
  document.getElementById("kpiItems").textContent=DB.items.length;
}

/* Bookings */
function openCalendarLegend(){
  openModal("مفتاح الألوان", `<div class="smallNote">يتلوّن اليوم عند وجود حجز. داخل اليوم ستجد مربع لكل قاعة.</div>`);
}
function resetBookingFilters(){
  document.getElementById("bkSearch").value="";
  document.getElementById("bkFilterDate").value="";
  refreshBookings();
}
function openBookingModal(editId=null){
  const halls=DB.halls;
  const b=editId?DB.bookings.find(x=>x.id===editId):null;
  openModal(editId?"تعديل حجز":"إضافة حجز", `
    <div class="row">
      <div class="field"><label>القاعة</label><select id="mHall">${halls.map(h=>`<option ${b&&b.hall===h?"selected":""} value="${esc(h)}">${esc(h)}</option>`).join("")}</select></div>
      <div class="field"><label>التاريخ</label><input id="mDate" type="date" value="${b?b.date:todayISO()}" /></div>
      <div class="field"><label>الفترة</label><select id="mPeriod">
        <option value="صباحية" ${b&&b.period==="صباحية"?"selected":""}>صباحية</option>
        <option value="مسائية" ${b&&b.period==="مسائية"?"selected":""}>مسائية</option>
      </select></div>
    </div>
    <div class="row">
      <div class="field"><label>اسم العميل</label><input id="mName" value="${b?esc(b.name):""}" /></div>
      <div class="field"><label>الهاتف</label><input id="mPhone" value="${b?esc(b.phone):""}" /></div>
    </div>
    <div class="row">
      <div class="field"><label>إجمالي</label><input id="mTotal" type="number" step="0.01" value="${b?Number(b.total||0):""}" /></div>
      <div class="field"><label>مدفوع</label><input id="mPaid" type="number" step="0.01" value="${b?Number(b.paid||0):""}" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn ok" onclick="${editId?`saveBookingEdit('${editId}')`:"saveBookingNew()"}">${editId?"حفظ":"إضافة"}</button>
      ${editId?`<button class="btn danger" onclick="deleteBooking('${editId}')">حذف</button>`:""}
    </div>
  `);
}
function saveBookingNew(){
  const hall=val("mHall"), date=val("mDate"), period=val("mPeriod");
  const name=val("mName").trim(), phone=val("mPhone").trim();
  const total=Number(val("mTotal")||0), paid=Number(val("mPaid")||0);
  if(!hall||!date||!period||!name||!phone||!total){ alert("يرجى إدخال البيانات المطلوبة"); return; }
  const remaining=Math.max(0,total-paid);
  DB.bookings.push({id:uid("bk"),hall,date,period,name,phone,total,paid,remaining});
  saveDB(); closeModal(); toast("تم إضافة الحجز");
  refreshBookings(); renderCalendar(); updateHomeKPIs();
}
function saveBookingEdit(id){
  const b=DB.bookings.find(x=>x.id===id); if(!b) return;
  b.hall=val("mHall"); b.date=val("mDate"); b.period=val("mPeriod");
  b.name=val("mName").trim(); b.phone=val("mPhone").trim();
  b.total=Number(val("mTotal")||0); b.paid=Number(val("mPaid")||0);
  if(!b.hall||!b.date||!b.period||!b.name||!b.phone||!b.total){ alert("يرجى إدخال البيانات المطلوبة"); return; }
  b.remaining=Math.max(0,b.total-b.paid);
  saveDB(); closeModal(); toast("تم تعديل الحجز");
  refreshBookings(); renderCalendar(); updateHomeKPIs();
}
function deleteBooking(id){
  if(!confirm("حذف الحجز؟")) return;
  DB.bookings=DB.bookings.filter(x=>x.id!==id);
  saveDB(); closeModal(); toast("تم حذف الحجز");
  refreshBookings(); renderCalendar(); updateHomeKPIs();
}
function bookingMatchesFilters(b){
  const q=(document.getElementById("bkSearch").value||"").trim().toLowerCase();
  const d=(document.getElementById("bkFilterDate").value||"").trim();
  if(q && !String(b.name||"").toLowerCase().includes(q)) return false;
  if(d && b.date!==d) return false;
  return true;
}
function refreshBookings(){
  const tb=document.getElementById("bookingsTbody");
  if(!tb) return;
  const list=DB.bookings.filter(bookingMatchesFilters).sort((a,b)=>(a.date+a.period).localeCompare(b.date+b.period));
  tb.innerHTML=list.map(b=>`
    <tr>
      <td>${b.date}</td>
      <td><span class="badge ${b.period==="مسائية"?"warn":"ok"}">${b.period}</span></td>
      <td>${esc(b.hall)}</td>
      <td>${esc(b.name)}</td>
      <td>${esc(b.phone)}</td>
      <td>${egp(b.total)}</td>
      <td>${egp(b.paid)}</td>
      <td><span class="badge ${b.remaining>0?"warn":"ok"}">${egp(b.remaining)}</span></td>
      <td><button class="btn secondary small" onclick="openBookingModal('${b.id}')">تعديل</button></td>
    </tr>
  `).join("") || `<tr><td colspan="9">لا يوجد</td></tr>`;
  document.getElementById("bkCountPill").textContent="عدد الحجوزات: "+list.length;
  document.getElementById("bkRemainingPill").textContent="إجمالي المتبقي: "+egp(list.reduce((s,x)=>s+Number(x.remaining||0),0));
}
function renderCalendar(){
  const cal=document.getElementById("calendar");
  const m=document.getElementById("calMonth"), y=document.getElementById("calYear");
  if(!cal||!m||!y) return;
  const month=Number(m.value), year=Number(y.value);
  const dow=["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
  const start=new Date(year,month,1);
  const end=new Date(year,month+1,0);
  const firstDay=start.getDay();
  const daysInMonth=end.getDate();
  let html=dow.map(d=>`<div class="dow">${d}</div>`).join("");
  for(let i=0;i<firstDay;i++) html+=`<div class="day muted"><div class="num">—</div></div>`;
  for(let day=1;day<=daysInMonth;day++){
    const dateISO=`${year}-${String(month+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
    const dayBookings=DB.bookings.filter(b=>b.date===dateISO);
    const has=dayBookings.length>0;
    const hallsHtml=DB.halls.map(h=>{
      const hb=dayBookings.filter(b=>b.hall===h);
      const booked=hb.length>0;
      return `<div class="${booked?"hallBox booked":"hallBox"}"><span>${esc(h.replace("قاعة ",""))}</span><span>${booked?hb.length+" حجز":"متاح"}</span></div>`;
    }).join("");
    html+=`<div class="day ${has?"hasBookings":""}" data-date="${dateISO}"><div class="num">${day}</div><div class="halls">${hallsHtml}</div></div>`;
  }
  cal.innerHTML=html;
  cal.onclick=(e)=>{ const d=e.target.closest(".day[data-date]"); if(!d) return; openDay(d.dataset.date); };
}
function openDay(dateISO){
  const list=DB.bookings.filter(b=>b.date===dateISO);
  openModal("حجوزات "+dateISO, `
    <div class="row spread"><div class="smallNote">عدد الحجوزات: ${list.length}</div><button class="btn small" onclick="openBookingModal()">إضافة</button></div>
    <div class="hr"></div>
    <div class="tableWrap"><table>
      <thead><tr><th>القاعة</th><th>الفترة</th><th>العميل</th><th>الهاتف</th><th>إجمالي</th><th>مدفوع</th><th>متبقي</th><th>إجراء</th></tr></thead>
      <tbody>
      ${list.map(b=>`<tr>
        <td>${esc(b.hall)}</td><td>${b.period}</td><td>${esc(b.name)}</td><td>${esc(b.phone)}</td>
        <td>${egp(b.total)}</td><td>${egp(b.paid)}</td><td>${egp(b.remaining)}</td>
        <td><button class="btn secondary small" onclick="openBookingModal('${b.id}')">تعديل</button></td>
      </tr>`).join("") || `<tr><td colspan="8">لا يوجد</td></tr>`}
      </tbody>
    </table></div>
  `);
}

/* Cash */
function fillTodayCash(){ document.getElementById("cashDate").value=todayISO(); }
function deptName(d){ return ({restaurant_cafe:"المطعم والكافيه",halls:"القاعات",kids:"كيدز اريا",other:"أخرى"})[d]||d; }
function addCash(){
  const date=val("cashDate")||todayISO();
  const type=val("cashType"), dept=val("cashDept");
  const amount=Number(val("cashAmount")||0);
  const note=val("cashNote").trim();
  if(!date||!type||!dept||!amount){ alert("يرجى إدخال البيانات المطلوبة"); return; }
  DB.cash.push({id:uid("cash"),date,type,dept,amount,note});
  saveDB(); toast("تم حفظ حركة الصندوق");
  document.getElementById("cashAmount").value=""; document.getElementById("cashNote").value="";
  refreshCash(); updateHomeKPIs();
}
function cashInRange(x){
  if(cashRange.from && x.date<cashRange.from) return false;
  if(cashRange.to && x.date>cashRange.to) return false;
  return true;
}
function applyCashRange(){ cashRange.from=val("cashFrom"); cashRange.to=val("cashTo"); refreshCash(); }
function resetCashRange(){ cashRange={from:"",to:""}; document.getElementById("cashFrom").value=""; document.getElementById("cashTo").value=""; refreshCash(); }
function refreshCash(){
  const tb=document.getElementById("cashTbody"); if(!tb) return;
  const list=DB.cash.filter(cashInRange).sort((a,b)=>b.date.localeCompare(a.date));
  tb.innerHTML=list.map(x=>`<tr>
    <td>${x.date}</td>
    <td><span class="badge ${x.type==="in"?"ok":"warn"}">${x.type==="in"?"مقبوضات":"مدفوعات"}</span></td>
    <td>${deptName(x.dept)}</td>
    <td>${egp(x.amount)}</td>
    <td>${esc(x.note||"")}</td>
    <td><button class="btn danger small" onclick="delCash('${x.id}')">حذف</button></td>
  </tr>`).join("") || `<tr><td colspan="6">لا يوجد</td></tr>`;
  const sumIn=list.filter(x=>x.type==="in").reduce((s,x)=>s+Number(x.amount||0),0);
  const sumOut=list.filter(x=>x.type==="out").reduce((s,x)=>s+Number(x.amount||0),0);
  const net=sumIn-sumOut;
  document.getElementById("cashSumIn").textContent=egp(sumIn);
  document.getElementById("cashSumOut").textContent=egp(sumOut);
  document.getElementById("cashNet").textContent=egp(net);
  document.getElementById("cashCount").textContent=list.length;
  document.getElementById("cashPill").textContent="صافي: "+egp(net);
}
function delCash(id){
  if(!confirm("حذف الحركة؟")) return;
  DB.cash=DB.cash.filter(x=>x.id!==id);
  saveDB(); refreshCash(); updateHomeKPIs();
}

/* Stock */
function resetItemForm(){
  ["itemName","itemQty","itemNote"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("itemUnit").value="وحدة";
  __editItemId=null;
}
function sumPurchases(itemId){ return DB.purchases.filter(p=>p.itemId===itemId).reduce((s,p)=>s+Number(p.qty||0),0); }
function sumOut(itemId){ return DB.stockOut.filter(o=>o.itemId===itemId).reduce((s,o)=>s+Number(o.qty||0),0); }
function currentQty(it){ return Number(it.qty0||0) + sumPurchases(it.id) - sumOut(it.id); }
function itemById(id){ return DB.items.find(i=>i.id===id); }
function saveItem(){
  const name=val("itemName").trim();
  const unit=val("itemUnit");
  const qty0=Number(val("itemQty")||0);
  const note=val("itemNote").trim();
  if(!name){ alert("اكتب اسم الصنف"); return; }
  if(__editItemId){
    const it=DB.items.find(i=>i.id===__editItemId); if(!it) return;
    it.name=name; it.unit=unit; it.qty0=qty0; it.note=note;
    toast("تم تعديل الصنف");
  }else{
    if(DB.items.some(i=>i.name===name)){ alert("الصنف موجود"); return; }
    DB.items.push({id:uid("it"),name,unit,qty0,note});
    toast("تم إضافة الصنف");
  }
  saveDB(); resetItemForm(); refreshStock(); updateHomeKPIs();
}
function fillTodayPurchase(){ document.getElementById("purDate").value=todayISO(); }
function addPurchase(){
  const date=val("purDate")||todayISO();
  const itemId=val("purItem");
  const qty=Number(val("purQty")||0);
  const supplier=val("purSupplier").trim();
  const cost=Number(val("purCost")||0);
  const note=val("purNote").trim();
  if(!date||!itemId||!qty){ alert("يرجى إدخال البيانات المطلوبة"); return; }
  DB.purchases.push({id:uid("pur"),date,itemId,qty,supplier,cost,note});
  saveDB(); toast("تم إضافة مشتريات");
  ["purQty","purSupplier","purCost","purNote"].forEach(id=>document.getElementById(id).value="");
  refreshStock(); updateHomeKPIs();
}
function fillTodayOut(){ document.getElementById("outDate").value=todayISO(); }
function addOut(){
  const date=val("outDate")||todayISO();
  const itemId=val("outItem");
  const qty=Number(val("outQty")||0);
  const note=val("outNote").trim();
  if(!date||!itemId||!qty){ alert("يرجى إدخال البيانات المطلوبة"); return; }
  DB.stockOut.push({id:uid("out"),date,itemId,qty,note});
  saveDB(); toast("تم تسجيل المنصرف");
  ["outQty","outNote"].forEach(id=>document.getElementById(id).value="");
  refreshStock(); updateHomeKPIs();
}
function fillTodayInv(){ document.getElementById("invDate").value=todayISO(); }
function addInventoryCheck(){
  const date=val("invDate")||todayISO();
  const itemId=val("invItem");
  const actual=Number(val("invActual")||0);
  const note=val("invNote").trim();
  if(!date||!itemId){ alert("يرجى إدخال البيانات المطلوبة"); return; }
  DB.inventoryChecks.push({id:uid("inv"),date,itemId,actual,note});
  saveDB(); toast("تم حفظ الجرد");
  ["invActual","invNote"].forEach(id=>document.getElementById(id).value="");
  refreshStock();
}
function editItem(id){
  const it=DB.items.find(i=>i.id===id); if(!it) return;
  __editItemId=id;
  document.getElementById("itemName").value=it.name;
  document.getElementById("itemUnit").value=it.unit;
  document.getElementById("itemQty").value=it.qty0;
  document.getElementById("itemNote").value=it.note||"";
  toast("عدل ثم احفظ");
}
function delItem(id){
  if(!confirm("حذف الصنف؟")) return;
  DB.items=DB.items.filter(i=>i.id!==id);
  DB.purchases=DB.purchases.filter(p=>p.itemId!==id);
  DB.stockOut=DB.stockOut.filter(o=>o.itemId!==id);
  DB.inventoryChecks=DB.inventoryChecks.filter(x=>x.itemId!==id);
  saveDB(); refreshStock(); updateHomeKPIs();
}
function delPurchase(id){
  if(!confirm("حذف المشتريات؟")) return;
  DB.purchases=DB.purchases.filter(p=>p.id!==id);
  saveDB(); refreshStock(); updateHomeKPIs();
}
function delOut(id){
  if(!confirm("حذف المنصرف؟")) return;
  DB.stockOut=DB.stockOut.filter(o=>o.id!==id);
  saveDB(); refreshStock(); updateHomeKPIs();
}
function delInv(id){
  if(!confirm("حذف الجرد؟")) return;
  DB.inventoryChecks=DB.inventoryChecks.filter(x=>x.id!==id);
  saveDB(); refreshStock();
}
function refreshStock(){
  const opts=DB.items.map(i=>`<option value="${i.id}">${esc(i.name)} (${esc(i.unit)})</option>`).join("");
  ["purItem","outItem","invItem"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.innerHTML=`<option value="">اختر...</option>`+opts;
  });

  const itemsTB=document.getElementById("itemsTbody");
  if(itemsTB){
    itemsTB.innerHTML=DB.items.map(it=>{
      const pur=sumPurchases(it.id);
      const out=sumOut(it.id);
      const cur=currentQty(it);
      return `<tr>
        <td>${esc(it.name)}</td><td>${esc(it.unit)}</td>
        <td>${egp(it.qty0)}</td><td>${egp(pur)}</td><td>${egp(out)}</td>
        <td><span class="badge ${cur<0?"warn":"ok"}">${egp(cur)}</span></td>
        <td>
          <button class="btn secondary small" onclick="editItem('${it.id}')">تعديل</button>
          <button class="btn danger small" onclick="delItem('${it.id}')">حذف</button>
        </td>
      </tr>`;
    }).join("") || `<tr><td colspan="7">لا يوجد</td></tr>`;
  }

  const purTB=document.getElementById("purTbody");
  if(purTB){
    const list=DB.purchases.slice().sort((a,b)=>b.date.localeCompare(a.date));
    purTB.innerHTML=list.map(p=>{
      const it=itemById(p.itemId);
      return `<tr>
        <td>${p.date}</td><td>${esc(it?it.name:"—")}</td><td>${egp(p.qty)}</td><td>${esc(p.supplier||"")}</td><td>${p.cost?egp(p.cost):"—"}</td>
        <td><button class="btn danger small" onclick="delPurchase('${p.id}')">حذف</button></td>
      </tr>`;
    }).join("") || `<tr><td colspan="6">لا يوجد</td></tr>`;
  }

  const outTB=document.getElementById("outTbody");
  if(outTB){
    const list=DB.stockOut.slice().sort((a,b)=>b.date.localeCompare(a.date));
    outTB.innerHTML=list.map(o=>{
      const it=itemById(o.itemId);
      return `<tr>
        <td>${o.date}</td><td>${esc(it?it.name:"—")}</td><td>${egp(o.qty)}</td><td>${esc(o.note||"")}</td>
        <td><button class="btn danger small" onclick="delOut('${o.id}')">حذف</button></td>
      </tr>`;
    }).join("") || `<tr><td colspan="5">لا يوجد</td></tr>`;
  }

  const invTB=document.getElementById("invTbody");
  if(invTB){
    const list=DB.inventoryChecks.slice().sort((a,b)=>b.date.localeCompare(a.date));
    invTB.innerHTML=list.map(x=>{
      const it=itemById(x.itemId);
      const recorded=it?currentQty(it):0;
      const actual=Number(x.actual||0);
      const diff=actual-recorded;
      const state=diff===0?"مطابق":(diff<0?"عجز":"زيادة");
      return `<tr>
        <td>${x.date}</td><td>${esc(it?it.name:"—")}</td><td>${egp(recorded)}</td><td>${egp(actual)}</td><td>${egp(diff)}</td><td>${state}</td>
        <td><button class="btn danger small" onclick="delInv('${x.id}')">حذف</button></td>
      </tr>`;
    }).join("") || `<tr><td colspan="7">لا يوجد</td></tr>`;
  }

  document.getElementById("stockItemsPill").textContent="الأصناف: "+DB.items.length;
  document.getElementById("stockValuePill").textContent="رصيد كمي: "+egp(DB.items.reduce((s,it)=>s+currentQty(it),0));
  document.getElementById("kpiItems").textContent=DB.items.length;
}

/* HR */
function resetEmpForm(){ ["empName","empRole","empSalary","empNote"].forEach(id=>document.getElementById(id).value=""); }
function addEmployee(){
  const name=val("empName").trim(), role=val("empRole").trim();
  const salary=Number(val("empSalary")||0), note=val("empNote").trim();
  if(!name||!salary){ alert("يرجى إدخال الاسم والراتب"); return; }
  DB.employees.push({id:uid("emp"),name,role,salary,note});
  saveDB(); toast("تم إضافة عامل"); resetEmpForm(); refreshHR();
}
function fillTodayAtt(){ document.getElementById("attDate").value=todayISO(); }
function addAttendance(){
  const date=val("attDate")||todayISO(), empId=val("attEmp");
  const tin=val("attIn"), tout=val("attOut");
  if(!date||!empId||!tin||!tout){ alert("يرجى إدخال البيانات المطلوبة"); return; }
  DB.attendance.push({id:uid("att"),date,empId,tin,tout});
  saveDB(); toast("تم حفظ الحضور"); refreshHR();
}
function fillTodayEmpTx(){ document.getElementById("empTxDate").value=todayISO(); }
function addEmpTx(){
  const date=val("empTxDate")||todayISO(), empId=val("empTxEmp"), type=val("empTxType");
  const amount=Number(val("empTxAmount")||0), note=val("empTxNote").trim();
  if(!date||!empId||!type||!amount){ alert("يرجى إدخال البيانات المطلوبة"); return; }
  DB.empTx.push({id:uid("etx"),date,empId,type,amount,note});
  saveDB(); toast("تم حفظ الحركة"); document.getElementById("empTxAmount").value=""; document.getElementById("empTxNote").value="";
  refreshHR();
}
function refreshHR(){
  const opts=DB.employees.map(e=>`<option value="${e.id}">${esc(e.name)}</option>`).join("");
  ["attEmp","empTxEmp"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.innerHTML=`<option value="">اختر...</option>`+opts;
  });
  document.getElementById("empCountPill").textContent="عدد العاملين: "+DB.employees.length;

  const empTB=document.getElementById("empTbody");
  if(empTB){
    empTB.innerHTML=DB.employees.map(e=>{
      const daily=Number(e.salary||0)/30;
      return `<tr>
        <td>${esc(e.name)}</td><td>${esc(e.role||"")}</td><td>${egp(e.salary)}</td><td>${egp(daily)}</td><td>${esc(e.note||"")}</td>
        <td><button class="btn danger small" onclick="delEmp('${e.id}')">حذف</button></td>
      </tr>`;
    }).join("") || `<tr><td colspan="6">لا يوجد</td></tr>`;
  }

  const attTB=document.getElementById("attTbody");
  if(attTB){
    const list=DB.attendance.slice().sort((a,b)=>b.date.localeCompare(a.date));
    attTB.innerHTML=list.map(x=>{
      const e=DB.employees.find(z=>z.id===x.empId);
      return `<tr>
        <td>${x.date}</td><td>${esc(e?e.name:"—")}</td><td>${x.tin}</td><td>${x.tout}</td><td>—</td>
        <td><button class="btn danger small" onclick="delAtt('${x.id}')">حذف</button></td>
      </tr>`;
    }).join("") || `<tr><td colspan="6">لا يوجد</td></tr>`;
  }

  const txTB=document.getElementById("empTxTbody");
  if(txTB){
    const list=DB.empTx.slice().sort((a,b)=>b.date.localeCompare(a.date));
    txTB.innerHTML=list.map(x=>{
      const e=DB.employees.find(z=>z.id===x.empId);
      const t=({advance:"سلفة",bonus:"مكافأة",penalty:"جزاء"})[x.type]||x.type;
      return `<tr>
        <td>${x.date}</td><td>${esc(e?e.name:"—")}</td><td>${t}</td><td>${egp(x.amount)}</td><td>${esc(x.note||"")}</td>
        <td><button class="btn danger small" onclick="delEmpTx('${x.id}')">حذف</button></td>
      </tr>`;
    }).join("") || `<tr><td colspan="6">لا يوجد</td></tr>`;
  }
}
function delEmp(id){
  if(!confirm("حذف العامل؟")) return;
  DB.employees=DB.employees.filter(e=>e.id!==id);
  DB.attendance=DB.attendance.filter(a=>a.empId!==id);
  DB.empTx=DB.empTx.filter(t=>t.empId!==id);
  saveDB(); refreshHR();
}
function delAtt(id){
  if(!confirm("حذف السجل؟")) return;
  DB.attendance=DB.attendance.filter(a=>a.id!==id);
  saveDB(); refreshHR();
}
function delEmpTx(id){
  if(!confirm("حذف الحركة؟")) return;
  DB.empTx=DB.empTx.filter(x=>x.id!==id);
  saveDB(); refreshHR();
}
function calcPayroll(){
  const from=val("payFrom"), to=val("payTo");
  if(!from||!to){ alert("اختر فترة"); return; }
  const days=Math.floor((new Date(to)-new Date(from))/(24*3600*1000))+1;
  let html=`الفترة: ${from} → ${to} (${days} يوم)

`;
  DB.employees.forEach(e=>{
    const daily=Number(e.salary||0)/30;
    const base=daily*days;
    const tx=DB.empTx.filter(x=>x.empId===e.id && x.date>=from && x.date<=to);
    const adv=tx.filter(x=>x.type==="advance").reduce((s,x)=>s+Number(x.amount||0),0);
    const bon=tx.filter(x=>x.type==="bonus").reduce((s,x)=>s+Number(x.amount||0),0);
    const pen=tx.filter(x=>x.type==="penalty").reduce((s,x)=>s+Number(x.amount||0),0);
    const net=base-adv+bon-pen;
    html += `${e.name}: صافي ${egp(net)}
`;
  });
  document.getElementById("payrollResult").textContent=html;
}
function resetPayroll(){
  document.getElementById("payFrom").value="";
  document.getElementById("payTo").value="";
  document.getElementById("payrollResult").textContent="اختر فترة واضغط حساب.";
}

/* Users */
function updateAuthUI(){
  document.getElementById("pillAuth").textContent=DB.authEnabled?"الصلاحيات مفعلة":"الدخول مباشر";
  document.getElementById("pillAuth").className=DB.authEnabled?"pill warn":"pill ok";
  document.getElementById("authEnabledPill").textContent=DB.authEnabled?"الصلاحيات: مفعلة":"الصلاحيات: غير مفعلة";
}
function toggleAuth(on){
  DB.authEnabled=!!on; saveDB(); updateAuthUI();
  toast(on?"تم تفعيل الصلاحيات":"تم إيقاف الصلاحيات","لا يفرض تسجيل دخول في هذه النسخة");
}
function roleName(r){
  return ({manager:"مدير",accountant:"محاسب",buyer:"مسؤول مشتريات",storekeeper:"مسؤول مخزن",attendance:"حضور/انصراف"})[r]||r;
}
function resetUserForm(){
  ["uName","uDesc","uPass"].forEach(id=>document.getElementById(id).value="");
  ["permBookings","permCash","permStock","permHr","permUsers","permDelete"].forEach(id=>{
    const c=document.getElementById(id); if(c) c.checked=(id!=="permUsers" && id!=="permDelete");
  });
  document.getElementById("uRole").value="manager";
}
function addUser(){
  const username=val("uName").trim(), desc=val("uDesc").trim(), password=val("uPass").trim(), role=val("uRole");
  if(!username){ alert("اكتب اسم المستخدم"); return; }
  if(DB.users.some(u=>u.username===username)){ alert("اسم المستخدم موجود"); return; }
  const perms={
    bookings:!!document.getElementById("permBookings").checked,
    cash:!!document.getElementById("permCash").checked,
    stock:!!document.getElementById("permStock").checked,
    hr:!!document.getElementById("permHr").checked,
    users:!!document.getElementById("permUsers").checked,
    canDelete:!!document.getElementById("permDelete").checked
  };
  DB.users.push({id:uid("u"),username,desc,password,role,perms});
  saveDB(); toast("تم إضافة المستخدم"); resetUserForm(); refreshUsers();
}
function refreshUsers(){
  const tb=document.getElementById("usersTbody"); if(!tb) return;
  tb.innerHTML=DB.users.map(u=>{
    const p=[]; if(u.perms?.bookings) p.push("الحجوزات"); if(u.perms?.cash) p.push("الصندوق"); if(u.perms?.stock) p.push("المخزون");
    if(u.perms?.hr) p.push("العاملين"); if(u.perms?.users) p.push("المستخدمين"); if(u.perms?.canDelete) p.push("حذف/تعديل");
    return `<tr><td>${esc(u.username)}</td><td>${esc(u.desc||"")}</td><td>${roleName(u.role)}</td><td>${p.join("، ")||"—"}</td>
      <td><button class="btn danger small" onclick="delUser('${u.id}')">حذف</button></td></tr>`;
  }).join("") || `<tr><td colspan="5">لا يوجد</td></tr>`;
}
function delUser(id){
  if(!confirm("حذف المستخدم؟")) return;
  DB.users=DB.users.filter(u=>u.id!==id);
  saveDB(); refreshUsers(); toast("تم حذف المستخدم");
}

/* Backup */
function exportJSON(){
  const data=JSON.stringify(DB,null,2);
  const blob=new Blob([data],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="backup_restocafe.json"; a.click();
  URL.revokeObjectURL(url);
  toast("تم تصدير نسخة احتياطية");
}
function importJSONFile(e){
  const file=e.target.files?.[0]; if(!file) return;
  const r=new FileReader();
  r.onload=()=>{
    try{ DB=Object.assign(defaultData(), JSON.parse(String(r.result||""))); saveDB(); toast("تم الاستيراد"); refreshAll(); }
    catch(err){ alert("ملف غير صالح"); }
  };
  r.readAsText(file);
}
function doImport(){
  const t=document.getElementById("impTxt").value.trim();
  try{ DB=Object.assign(defaultData(), JSON.parse(t)); saveDB(); toast("تم الاستيراد"); refreshAll(); }
  catch(e){ alert("JSON غير صالح"); }
}
function resetAllData(){
  if(!confirm("مسح كل البيانات؟")) return;
  DB=defaultData(); saveDB(); toast("تم مسح البيانات"); refreshAll();
}

/* Refresh all */
function refreshAll(){
  updateAuthUI();
  refreshBookings();
  renderCalendar();
  refreshCash();
  refreshStock();
  refreshHR();
  refreshUsers();
  updateHomeKPIs();
}

/* Start */
function initOnce(){
  if(window.__appInit) return;
  window.__appInit=true;
  ["cashDate","purDate","outDate","invDate","attDate","empTxDate"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value=todayISO();
  });
  bindNav(); bindModal(); initCalendarSelectors();
  document.addEventListener("click",(e)=>{
    const b=e.target.closest("button[data-nav]"); if(!b) return;
    e.preventDefault(); go(b.getAttribute("data-nav"));
  });
  activateByHash();
}
window.addEventListener("load", initOnce);
</script>

</body>
</html>
